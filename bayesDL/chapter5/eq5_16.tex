\documentclass{jsarticle}
\usepackage{amsmath,amssymb,amsfonts}

\begin{document}
式(5.16)を見直してみる。

式(4.21)の上を参考にすると、
\begin{equation}
-\mathcal{U}(z) = ln \, \tilde{p}(z) \quad (ln \, p(z) \propto ln \, \tilde{p}(z))
\end{equation}
このとき、$p(z)$から$z$をサンプリングしたい。

さて、今回、P.117にあるように$p(W|Y,X)$から、$W$をサンプリングしたい。

よって、1倍は比例でもあるので、$\tilde{p}(W|Y, X) = p(W|Y, X)$として、
\begin{equation}
\label{U}
\mathcal{U}(W) = - ln \, \tilde{p}(W | Y, X) = - ln \, p(W | Y, X) = - ln \, \frac{p(W, Y | X)}{p(Y | X)} = - ln \, \frac{p(Y | W, X)p(W | X)}{p(Y | X)} = - ln \, \frac{p(Y | W, X)p(W)}{p(Y | X)}
\end{equation}
ここで、(5.1)を考えると、$W$と$X$は独立で、$p(W | X) = p(W)$となることに注意する。

(4.16),(4.17)を考慮すると、$\mathcal{U}(W)$は微分だけで考慮されている。
すると、(\ref{U})で$p(Y | X)$はWを変数とすると、定数となり、無視できる。

(\ref{U})を考え、(5.10)の導出過程を考慮すると、以下のようになる。
\begin{equation}
\mathcal{U}(W) = - ln \, p(Y | W, X)p(W) + c= \sum_{n = 1}^N (-\frac{1}{{\sigma_y}^2}\frac{1}{2}(y_n - f(x_n;W))^2) + \frac{1}{{\sigma_w}^2}\frac{1}{2}w^T w + c = \frac{1}{{\sigma_y}^2} E(W) + \frac{1}{{\sigma_w}^2} \Omega_{L2}(W) + c
\end{equation}

なお、cはWに影響しない項になっている。HMCのやり方(2のリープフロッグ法、3の比率の計算)を考えると、定数部分は無視できる。

\begin{equation}
\mathcal{U}(W) \sim \frac{1}{{\sigma_y}^2} E(W) + \frac{1}{{\sigma_w}^2} \Omega_{L2}(W)
\end{equation}

上記の式の偏微分を考慮すると、(5.8)が利用できることがわかる。
\begin{equation}
\frac{\partial\mathcal{U}}{\partial w_i} = \frac{1}{{\sigma_y}^2}\frac{\partial}{\partial w_i}E(W)+\frac{1}{{\sigma_w}^2}\frac{\partial}{\partial w_i}\Omega_{L2}(W)
\end{equation}
\begin{equation}
\nabla_{w} \mathcal{U}(W) = \frac{1}{{\sigma_y}^2}\nabla_{w} E(W)+\frac{1}{{\sigma_w}^2}W
\end{equation}
なお、PRMLの演習11.15を考慮すると、(4.14),(4.15)は以下のように、一部、偏微分になるはず。
\begin{equation}
\frac{d z_i}{d t} = \frac{\partial H}{\partial p_i} = \frac{\partial K}{\partial p_i}
\end{equation}
\begin{equation}
\frac{d p_i}{d t} = -\frac{\partial H}{\partial z_i} = -\frac{\partial U}{\partial z_i}
\end{equation}
よって、(4.16)の該当部分の全微分は偏微分に変わる。
\end{document}
