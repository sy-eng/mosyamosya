\documentclass{jsarticle}
\usepackage{amsmath,amssymb,amsfonts}

\begin{document}
(13.17)に関して、本のとおりに考える。
求めたい式は(13.12)の
\begin{equation}
\label{Q}
Q(\theta, \theta^{old})=\sum_{\bf z} p({\bf Z} | {\bf X}, \theta^{old}) ln \, p({\bf X}, {\bf Z} | \theta)=\sum_{{\bf z}_1, ..., {\bf z}_N} p({\bf z}_1, ..., {\bf z}_N | {\bf X}, \theta^{old}) ln \, p({\bf X}, {\bf z}_1, ..., {\bf z}_N | \theta)
\end{equation}

(13.6)相当の(13.10)に(13.7),(13.8),(13.9)を代入する。ただし、(13.10)のmはnに変えてある。
\begin{equation}
p({\bf X}, {\bf Z} | \theta) = p({\bf z}_1 | {\bf \pi})[\prod_{n=2}^N p({\bf z}_n | {\bf z}_{n-1}, A)]\prod_{m=1}^N p({\bf x}_m | {\bf z}_{m}, \phi)=\prod_{k=1}^{K} \pi_{k}^{z_{1k}} [\prod_{n=2}^N \prod_{j=1}^K \prod_{k=1}^K A_{j k}^{z_{n-1}z_n}] \prod_{n=1}^N \prod_{k=1}^{K} p({\bf x}_n | \phi_{k})^{z_{nk}}
\end{equation}

上記2式より、
\begin{equation}
Q(\theta, \theta^{old}) = \sum_{{\bf z}_1, ..., {\bf z}_N} p({\bf Z} | {\bf X}, \theta^{old}) (\sum_{k=1}^{K} z_{1k} \, ln \, \pi_{k} + \sum_{n=2}^N \sum_{j=1}^K \sum_{k=1}^K z_{n-1}z_n \, ln \, A_{j k} + \sum_{n=1}^N \sum_{k=1}^{K} z_{nk} \, ln \, p({\bf x}_n | \phi_{k}))
\end{equation}

カッコの1項目を考える。${\bf z}_2, ..., {\bf z}_2$について、周辺化する。$z_{1k}$は${\bf z}_1$に依存するので、${\bf z}_1$は周辺化できない。
\begin{equation}
\begin{split}
\sum_{{\bf z}_1, ..., {\bf z}_N} p({\bf Z} | {\bf X}, \theta^{old}) \sum_{k=1}^{K} z_{1k} \, ln \, \pi_{k} = \sum_{k=1}^{K} \sum_{{\bf z}_1, ..., {\bf z}_N} p({\bf z}_1, {\bf z}_2, ..., {\bf z}_N | {\bf X}, \theta^{old}) z_{1k} \, ln \, \pi_{k} \\
= \sum_{k=1}^{K} \sum_{{\bf z}_1} p({\bf z}_1 | {\bf X}, \theta^{old})  z_{1k} \, ln \, \pi_{k} = \sum_{k=1}^{K} (\sum_{{\bf z}_1} \gamma({\bf z}_1)  z_{1k}) \, ln \, \pi_{k}
= \sum_{k=1}^{K} \gamma(z_{1k}) \, ln \, \pi_{k}
\end{split}
\end{equation}
ここでは、(13.13),(13.15)も利用している。

同様に2項目を考えると、nに依存して、${\bf z}_{n-1}, {\bf z}_{n}$が周辺化できない。
\begin{equation}
\begin{split}
\sum_{{\bf z}_1, ..., {\bf z}_N} p({\bf Z} | {\bf X}, \theta^{old}) \sum_{n=2}^N \sum_{j=1}^K \sum_{k=1}^K z_{n-1,j}z_{n,k} \, ln \, A_{j k} = \sum_{n=2}^N \sum_{j=1}^K \sum_{k=1}^K \sum_{{\bf z}_1, ..., {\bf z}_N} p({\bf z}_1, ..., {\bf z}_N | {\bf X}, \theta^{old}) z_{n-1}z_n \, ln \, A_{j k}\\
= \sum_{n=2}^N \sum_{j=1}^K \sum_{k=1}^K \sum_{{\bf z}_{n-1}, {\bf z}_{n}} p({\bf z}_{n-1}, {\bf z}_{n} | {\bf X}, \theta^{old}) z_{n-1}z_n \, ln \, A_{j k}
= \sum_{n=2}^N \sum_{j=1}^K \sum_{k=1}^K (\sum_{{\bf z}_{n-1}, {\bf z}_{n}} \xi({\bf z}_{n-1}, {\bf z}_{n}) z_{n-1}z_n) \, ln \, A_{j k}\\
= \sum_{n=2}^N \sum_{j=1}^K \sum_{k=1}^K \xi({\bf z}_{n-1,j}, {\bf z}_{n,k}) \, ln \, A_{j k}\end{split}
\end{equation}
ここでは、(13.14),(13.16)も利用している。

3項目は
\begin{equation}
\begin{split}
\sum_{{\bf z}_1, ..., {\bf z}_N} p({\bf Z} | {\bf X}, \theta^{old}) \sum_{n=1}^N \sum_{k=1}^{K} z_{mk} \, ln \, p({\bf x}_m | \phi_{k}) = \sum_{n=1}^N \sum_{k=1}^{K} \sum_{{\bf z}_1, ..., {\bf z}_N} p({\bf z}_1, ..., {\bf z}_N | {\bf X}, \theta^{old}) z_{nk} \, ln \, p({\bf x}_n | \phi_{k})\\
= \sum_{n=1}^N \sum_{k=1}^{K} \sum_{{\bf z}_n} p({\bf z}_n | {\bf X}, \theta^{old}) z_{nk} \, ln \, p({\bf x}_n | \phi_{k}) = \sum_{n=1}^N \sum_{k=1}^{K} (\sum_{{\bf z}_n} \gamma({\bf z}_n) z_{nk}) \, ln \, p({\bf x}_n | \phi_{k})
= \sum_{n=1}^N \sum_{k=1}^{K} \gamma({\bf z}_{nk}) \, ln \, p({\bf x}_n | \phi_{k})\\
\end{split}
\end{equation}

上記より、
\begin{equation}
Q(\theta, \theta^{old}) = \sum_{k=1}^K \gamma(z_{1k})\, ln\, \pi_k + \sum_{n=2}^{N} \sum_{j=1}^{K}\sum_{k=1}^{K} \xi(z_{n-1,j}, z_{n, k})\, ln\, A_{jk} + \sum_{n=1}^{N} \sum_{k=1}^{K}\gamma(z_{nk})\, ln\, p({\bf x}_n | \phi_k)
\end{equation}
となる。
\end{document}
